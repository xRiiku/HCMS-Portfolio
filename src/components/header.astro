<header
  class="dark:bg-primary-50 text-tbase-500/90 sticky top-0 z-50 flex w-full items-center justify-between bg-white px-4 py-4 md:px-6"
>
  <div class="font-instrument text-center text-xl font-bold text-nowrap">
    <a href="/" class="hover:text-primary-500 transition-colors">DrDev</a>
  </div>

  <!-- NAV DESKTOP -->
  <nav class="hidden items-center gap-8 md:flex" aria-label="Main navigation">
    <a href="/" class="font-geist hover:text-primary-500 font-semibold transition-colors">Inicio</a>
    <a href="/projects" class="font-geist hover:text-primary-500 font-semibold transition-colors">Proyectos</a>
    <a href="/blog" class="font-geist hover:text-primary-500 font-semibold transition-colors">Blog</a>

    <!-- Botón toggle (desktop) -->
    <button
      id="theme-toggle"
      class="bg-primary-50 dark:bg-primary-200 hover:bg-primary-100 dark:hover:bg-primary-100 relative flex h-10 w-10 cursor-pointer items-center justify-center rounded-full transition-colors duration-300 hover:shadow-lg"
    >
      <span class="sr-only">Cambiar tema</span>
      <div class="relative h-6 w-6 overflow-hidden">
        <!-- Moon icon -->
        <svg
          class="absolute h-full w-full scale-100 rotate-0 opacity-100 transition-all duration-500 dark:scale-0 dark:-rotate-90 dark:opacity-0"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" fill="currentColor"></path>
        </svg>

        <!-- Sun icon -->
        <svg
          class="absolute h-full w-full scale-0 rotate-90 text-white opacity-0 transition-all duration-500 dark:scale-100 dark:rotate-0 dark:opacity-100"
          viewBox="0 0 24 24"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M12 2V4M12 20V22M4 12H2M6.31412 6.31412L4.8999 4.8999M17.6859 6.31412L19.1001 4.8999M6.31412 17.69L4.8999 19.1042M17.6859 17.69L19.1001 19.1042M22 12H20M17 12C17 14.7614 14.7614 17 12 17C9.23858 17 7 14.7614 7 12C7 9.23858 9.23858 7 12 7C14.7614 7 17 9.23858 17 12Z"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          ></path>
        </svg>
      </div>
    </button>
  </nav>

  <!-- BOTÓN HAMBURGUESA (MÓVIL) -->
  <button
    id="mobile-menu-open"
    class="cursor-pointer bg-primary-50 dark:bg-primary-200 hover:bg-primary-100 dark:hover:bg-primary-100 relative flex h-10 w-10 items-center justify-center rounded-full transition-colors duration-300 hover:shadow-lg md:hidden"
    aria-label="Abrir menú"
    aria-controls="mobile-menu"
    aria-expanded="false"
  >
    <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" xmlns="http://www.w3.org/2000/svg">
      <path d="M4 7H20M4 12H20M4 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
    </svg>
  </button>
</header>

<!-- MENÚ MÓVIL FULLSCREEN -->
<div
  id="mobile-menu"
  class="mobile-menu fixed inset-0 z-[60] hidden md:hidden"
  role="dialog"
  aria-modal="true"
  aria-label="Menú"
>
  <!-- overlay -->
  <div id="mobile-menu-overlay" class="mobile-menu__overlay absolute inset-0"></div>

  <!-- panel -->
  <div class="mobile-menu__panel relative flex h-full w-full flex-col">
    <div class="flex items-center justify-between px-6 py-6">
      <div class="font-instrument text-xl font-bold">
        <a href="/" class="hover:text-primary-500 transition-colors">DrDev</a>
      </div>

      <button
        id="mobile-menu-close"
        class="cursor-pointer bg-primary-50 dark:bg-primary-200 hover:bg-primary-100 dark:hover:bg-primary-100 flex h-10 w-10 items-center justify-center rounded-full transition-colors duration-300 hover:shadow-lg"
        aria-label="Cerrar menú"
      >
        <svg viewBox="0 0 24 24" class="h-6 w-6" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M6 6L18 18M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>
    </div>

    <nav class="flex flex-1 flex-col justify-center gap-6 px-6" aria-label="Mobile navigation">
      <a href="/" class="mobile-link font-geist text-3xl font-semibold hover:text-primary-500 transition-colors">Inicio</a>
      <a
        href="/projects"
        class="mobile-link font-geist text-3xl font-semibold hover:text-primary-500 transition-colors"
      >
        Proyectos
      </a>
      <a href="/blog" class="mobile-link font-geist text-3xl font-semibold hover:text-primary-500 transition-colors">
        Blog
      </a>

      <div class="mt-10 flex items-center gap-3">
        <!-- Toggle tema (móvil) -->
        <button
          id="theme-toggle-mobile"
          class="bg-primary-50 dark:bg-primary-200 hover:bg-primary-100 dark:hover:bg-primary-100 relative flex h-12 w-12 cursor-pointer items-center justify-center rounded-full transition-colors duration-300 hover:shadow-lg"
        >
          <span class="sr-only">Cambiar tema</span>
          <div class="relative h-6 w-6 overflow-hidden">
            <!-- Moon icon -->
            <svg
              class="absolute h-full w-full scale-100 rotate-0 opacity-100 transition-all duration-500 dark:scale-0 dark:-rotate-90 dark:opacity-0"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" fill="currentColor"></path>
            </svg>

            <!-- Sun icon -->
            <svg
              class="absolute h-full w-full scale-0 rotate-90 text-white opacity-0 transition-all duration-500 dark:scale-100 dark:rotate-0 dark:opacity-100"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12 2V4M12 20V22M4 12H2M6.31412 6.31412L4.8999 4.8999M17.6859 6.31412L19.1001 4.8999M6.31412 17.69L4.8999 19.1042M17.6859 17.69L19.1001 19.1042M22 12H20M17 12C17 14.7614 14.7614 17 12 17C9.23858 17 7 14.7614 7 12C7 9.23858 9.23858 7 12 7C14.7614 7 17 9.23858 17 12Z"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              ></path>
            </svg>
          </div>
        </button>

        <span class="font-geist text-base opacity-80">Tema</span>
      </div>
    </nav>
  </div>
</div>

<style>
  /* Menú móvil: fondo y panel con transiciones */
  .mobile-menu__overlay {
    background: rgba(0, 0, 0, 0.35);
    opacity: 0;
    transition: opacity 280ms ease;
  }

  .mobile-menu__panel {
    background: white;
    color: inherit;
    transform: translateY(-8px);
    opacity: 0;
    transition: transform 320ms ease, opacity 320ms ease;
  }

  :root.dark .mobile-menu__panel {
    background: rgb(15 23 42); /* similar a slate-900 */
  }

  /* Estado abierto */
  .mobile-menu.is-open {
    display: block;
  }
  .mobile-menu.is-open .mobile-menu__overlay {
    opacity: 1;
  }
  .mobile-menu.is-open .mobile-menu__panel {
    transform: translateY(0);
    opacity: 1;
  }

  /* Evitar scroll cuando está abierto */
  body.no-scroll {
    overflow: hidden;
    height: 100%;
  }

  /* Si prefieres un slide lateral, dímelo y te lo cambio a translateX */
</style>

<script>
  const handleThemeToggle = () => {
    const html = document.documentElement;
    html.classList.toggle('dark');
    localStorage.setItem('theme', html.classList.contains('dark') ? 'dark' : 'light');
  };

  const initThemeToggle = () => {
    const html = document.documentElement;
    const storedTheme = localStorage.getItem('theme');

    if (storedTheme) html.classList.toggle('dark', storedTheme === 'dark');
    if (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches) html.classList.add('dark');

    const desktopBtn = document.getElementById('theme-toggle');
    const mobileBtn = document.getElementById('theme-toggle-mobile');

    desktopBtn?.removeEventListener('click', handleThemeToggle);
    mobileBtn?.removeEventListener('click', handleThemeToggle);

    desktopBtn?.addEventListener('click', handleThemeToggle);
    mobileBtn?.addEventListener('click', handleThemeToggle);
  };

  // --- Mobile menu logic ---
  const openMobileMenu = () => {
    const menu = document.getElementById('mobile-menu');
    const openBtn = document.getElementById('mobile-menu-open');
    if (!menu) return;

    menu.classList.add('is-open');
    document.body.classList.add('no-scroll');
    openBtn?.setAttribute('aria-expanded', 'true');
  };

  const closeMobileMenu = () => {
    const menu = document.getElementById('mobile-menu');
    const openBtn = document.getElementById('mobile-menu-open');
    if (!menu) return;

    menu.classList.remove('is-open');
    document.body.classList.remove('no-scroll');
    openBtn?.setAttribute('aria-expanded', 'false');
  };

  const initMobileMenu = () => {
    const menu = document.getElementById('mobile-menu');
    const openBtn = document.getElementById('mobile-menu-open');
    const closeBtn = document.getElementById('mobile-menu-close');
    const overlay = document.getElementById('mobile-menu-overlay');

    // Limpieza (por astro swaps)
    openBtn?.replaceWith(openBtn.cloneNode(true));
    closeBtn?.replaceWith(closeBtn.cloneNode(true));
    overlay?.replaceWith(overlay.cloneNode(true));

    const openBtn2 = document.getElementById('mobile-menu-open');
    const closeBtn2 = document.getElementById('mobile-menu-close');
    const overlay2 = document.getElementById('mobile-menu-overlay');

    openBtn2?.addEventListener('click', openMobileMenu);
    closeBtn2?.addEventListener('click', closeMobileMenu);
    overlay2?.addEventListener('click', closeMobileMenu);

    // Cerrar al clicar en un link del menú
    menu?.querySelectorAll('a.mobile-link').forEach((a) => a.addEventListener('click', closeMobileMenu));

    // Cerrar con ESC
    document.removeEventListener('keydown', onEscKey);
    document.addEventListener('keydown', onEscKey);

    function onEscKey(e: KeyboardEvent) {
      if (e.key === 'Escape') closeMobileMenu();
    }

    // Si cambias a desktop con el menú abierto, lo cerramos
    const mq = window.matchMedia('(min-width: 768px)');
    mq.onchange = () => {
      if (mq.matches) closeMobileMenu();
    };
  };

  // Init on first load
  initThemeToggle();
  initMobileMenu();

  // Re-init after each view transition
  document.addEventListener('astro:after-swap', () => {
    initThemeToggle();
    initMobileMenu();
  });
</script>
